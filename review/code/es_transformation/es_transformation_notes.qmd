# ES Transformation notes

## Estimating Cohen's d or Hedges' g from a Ratio of Rate Ratios

The `esc_ratio_rate_ratio` function estimates Cohen's d or Hedges' g effect sizes from a reported ratio of rate ratios, its standard error or confidence interval, sample sizes, and the population baseline rate. The method relies on several assumptions and approximations to convert the ratio of rate ratios to a standardized mean difference.

### Assumptions

1. The ratio of rate ratios is a measure of the relative difference in event rates between the treatment and comparison groups, with the comparison group as the reference [@rothman2008].
2. The standard error of the ratio of rate ratios is either provided or can be calculated from the confidence interval assuming a normal distribution [@altman2011].
3. The population baseline rate represents the proportion of the population experiencing the event at baseline and is known or can be estimated [@rothman2008].
4. The event counts in the treatment and comparison groups follow a Poisson distribution [@fleiss2003].
5. The sample sizes of the treatment and comparison groups are known.

### Step 1: Obtain the standard error of the ratio of rate ratios

The function first obtains the standard error of the ratio of rate ratios either directly from the provided `ratio_rate_ratio_se` argument or by calculating it from the confidence interval using the following formula [@altman2011]:

$$
SE_{RRR} = \frac{RRR_{upper} - RRR_{lower}}{2 \times 1.96}
$$

```{r}
se_ratio_rate_ratio <- (ratio_rate_ratio_ci_upper - ratio_rate_ratio_ci_lower) / (2 * 1.96)
```

where $SE_{RRR}$ is the standard error of the ratio of rate ratios, $RRR_{upper}$ and $RRR_{lower}$ are the upper and lower bounds of the ratio of rate ratios confidence interval, respectively.

Step 2: Estimate the event counts

The event count for the comparison group is estimated using the population baseline rate and the comparison group sample size:

$$
E_C = n_C \times BR
$$

where $E_C$ is the event count for the comparison group, $n_C$ is the comparison group sample size, and $BR$ is the population baseline rate.

```{r}
comparison_event_count <- comparison_n * population_baseline_rate
```

The event count for the treatment group is then estimated using the ratio of rate ratios and the comparison event count:

$$
E_T = E_C \times RRR
$$

where $E_T$ is the event count for the treatment group, and $RRR$ is the ratio of rate ratios.

```{r}
treatment_event_count <- comparison_event_count * ratio_rate_ratio
```

Step 3: Calculate the pooled event rate and standard deviation

The pooled event count is calculated as the average of the treatment and comparison event counts:

$$
E_P = \frac{E_T + E_C}{2}
$$

where $E_P$ is the pooled event count.

```{r}
pooled_event_count <- (treatment_event_count + comparison_event_count) / 2
```

The pooled event rate is then estimated by dividing the pooled event count by the average of the treatment and comparison sample sizes:

$$
R_P = \frac{E_P}{\frac{n_T + n_C}{2}}
$$

where $R_P$ is the pooled event rate, and $n_T$ and $n_C$ are the treatment and comparison group sample sizes, respectively.

```{r}
pooled_event_rate <- pooled_event_count / ((treatment_n + comparison_n) / 2)
```

The pooled standard deviation is estimated using the pooled event rate, assuming a Poisson distribution [@fleiss2003]:

$$
SD_P = \sqrt{R_P \times (1 - R_P)}
$$

where $SD_P$ is the pooled standard deviation.

```{r}
pooled_sd <- sqrt(pooled_event_rate * (1 - pooled_event_rate))
```

Step 4: Calculate Cohen's d

Cohen's d is calculated using the estimated event rates for the treatment and comparison groups and the pooled standard deviation [@cohen1988]:

$$
d = \frac{\frac{E_T}{n_T} - \frac{E_C}{n_C}}{SD_P}
$$

where $d$ is Cohen's d.

```{r}
cohens_d <- (treatment_event_count / treatment_n - comparison_event_count / comparison_n) / pooled_sd
```

Step 5: Calculate the standard error and confidence interval for Cohen's d

The standard error for Cohen's d is estimated using the event rates and sample sizes:

$$
SE_d = \sqrt{\frac{E_T}{n_T^2} + \frac{E_C}{n_C^2}} \times \frac{1}{SD_P}
$$

where $SE_d$ is the standard error for Cohen's d, $E_T$ and $E_C$ are the event counts in the treatment and comparison groups, respectively, $n_T$ and $n_C$ are the sample sizes of the treatment and comparison groups, respectively, and $SD_P$ is the pooled standard deviation.

```{r}
standard_error_d <- sqrt((treatment_event_count / treatment_n^2) + (comparison_event_count / comparison_n^2)) / pooled_sd
```

The confidence interval for Cohen's d is then calculated using the standard error [@nakagawa2007]:

$$
CI_d = [d - 1.96 \times SE_d, d + 1.96 \times SE_d]
$$

where $CI_d$ is the confidence interval for Cohen's d.

```{r}
cohens_d_ci_lower <- cohens_d - (1.96 * standard_error_d)
cohens_d_ci_upper <- cohens_d + (1.96 * standard_error_d)
```

Step 6: Calculate Hedges' g (optional)

If the esc_type argument is set to 'g', the function also calculates Hedges' g, which is an unbiased estimate of the standardized mean difference [@hedges1981]:

$$
g = d \times \left(1 - \frac{3}{4 \times (n_T + n_C) - 9}\right)
$$

where $g$ is Hedges' g.

```{r}
hedges_g <- cohens_d * (1 - (3 / (4 * (treatment_n + comparison_n) - 9)))
```

The confidence interval for Hedges' g is calculated using the same standard error as Cohen's d.

## References

Altman, D. G., & Bland, J. M. (2011). How to obtain the confidence interval from a P value. BMJ, 343, d2090. https://doi.org/10.1136/bmj.d2090

Cohen, J. (1988). Statistical power analysis for the behavioral sciences (2nd ed.). Lawrence Erlbaum Associates.

Fleiss, J. L., Levin, B., & Paik, M. C. (2003). Statistical methods for rates and proportions (3rd ed.). John Wiley & Sons.

Hedges, L. V. (1981). Distribution theory for Glass's estimator of effect size and related estimators. Journal of Educational Statistics, 6(2), 107-128. https://doi.org/10.3102/10769986006002107

Nakagawa, S., & Cuthill, I. C. (2007). Effect size, confidence interval and statistical significance: A practical guide for biologists. Biological Reviews, 82(4), 591-605. https://doi.org/10.1111/j.1469-185X.2007.00027.x

Rothman, K. J., Greenland, S., & Lash, T. L. (2008). Modern epidemiology (3rd ed.). Lippincott Williams & Wilkins.

VanderWeele, T. J. (2017). On a square-root transformation of the odds ratio for a common outcome. Epidemiology, 28(6), e58-e60. https://doi.org/10.1097/EDE.0000000000000733

## Estimating Cohen's d or Hedges' g from a Mean Difference

The `esc_mean_difference` function estimates Cohen's d or Hedges' g effect sizes from a reported mean difference, its standard error or confidence interval, and the sample sizes of the treatment and comparison groups. The function calculates the pooled standard deviation, effect size, standard error, confidence interval, and p-value.

### Assumptions

1. The mean difference between the treatment and comparison groups is provided.
2. The standard error of the mean difference is either provided or can be calculated from the confidence interval assuming a normal distribution [@altman2011].
3. The sample sizes of the treatment and comparison groups are known.
4. The variance of the outcome is assumed to be equal in both groups.

### Step 1: Obtain the standard error of the mean difference

The function first obtains the standard error of the mean difference either directly from the provided `mean_diff_se` argument or by calculating it from the confidence interval using the following formula [@altman2011]:

$$
SE_{MD} = \frac{MD_{upper} - MD_{lower}}{2 \times 1.96}
$$

```{r}
standard_error <- (mean_diff_ci_upper - mean_diff_ci_lower) / (2 * 1.96)
```

where $SE_{MD}$ is the standard error of the mean difference, $MD_{upper}$ and $MD_{lower}$ are the upper and lower bounds of the mean difference confidence interval, respectively.

### Step 2: Estimate the pooled standard deviation

The pooled standard deviation is estimated using the standard error and the sample sizes of the treatment and comparison groups:

$$
SD_{pooled} = \frac{SE_{MD}}{\sqrt{\frac{1}{n_T} + \frac{1}{n_C}}}
$$

where $SD_{pooled}$ is the pooled standard deviation, $SE_{MD}$ is the standard error of the mean difference, and $n_T$ and $n_C$ are the sample sizes of the treatment and comparison groups, respectively.

```{r}
standard_deviation_pooled <- standard_error / sqrt((1 / treatment_n) + (1 / comparison_n))
```

### Step 3: Calculate Cohen's d

Cohen's d is calculated by dividing the mean difference by the pooled standard deviation [@cohen1988]:

$$
d = \frac{MD}{SD_{pooled}}
$$

where $d$ is Cohen's d, $MD$ is the mean difference, and $SD_{pooled}$ is the pooled standard deviation.

```{r}
cohens_d <- mean_difference / standard_deviation_pooled
```

### Step 4: Calculate the standard error and confidence interval for Cohen's d

The standard error for Cohen's d is calculated by dividing the standard error of the mean difference by the pooled standard deviation:

$$
SE_d = \frac{SE_{MD}}{SD_{pooled}}
$$

where $SE_d$ is the standard error for Cohen's d.

```{r}
standard_error_d <- standard_error / standard_deviation_pooled
```

The confidence interval for Cohen's d is then calculated using the standard error [@nakagawa2007]:

$$
CI_d = [d - 1.96 \times SE_d, d + 1.96 \times SE_d]
$$

where $CI_d$ is the confidence interval for Cohen's d.

```{r}
mean_diff_ci_lower_d <- cohens_d - (1.96 * standard_error_d)
mean_diff_ci_upper_d <- cohens_d + (1.96 * standard_error_d)
```

### Step 5: Calculate the p-value

The t-statistic is calculated by dividing the mean difference by its standard error:

$$
t = \frac{MD}{SE_{MD}}
$$

where $t$ is the t-statistic.

```{r}
t_stat <- mean_difference / standard_error
```

The degrees of freedom are calculated as the sum of the sample sizes minus 2:

$$
df = n_T + n_C - 2
$$

where $df$ is the degrees of freedom.

```{r}
df <- treatment_n + comparison_n - 2
```

The p-value is then calculated using the t-distribution with the calculated degrees of freedom [@cumming2012]:

```{r}
p_value <- 2 * (1 - pt(abs(t_stat), df))
```

### Step 6: Calculate Hedges' g (optional)

If the `esc_type` argument is set to 'g', the function also calculates Hedges' g, which is an unbiased estimate of the standardized mean difference [@hedges1981]:

$$
g = d \times \left(1 - \frac{3}{4 \times (n_T + n_C) - 9}\right)
$$

where $g$ is Hedges' g.

```{r}
hedges_g <- cohens_d * (1 - (3 / (4 * (treatment_n + comparison_n) - 9)))
```

The confidence interval for Hedges' g is calculated using the same standard error as Cohen's d.

## References

Altman, D. G., & Bland, J. M. (2011). How to obtain the confidence interval from a P value. BMJ, 343, d2090. https://doi.org/10.1136/bmj.d2090

Cohen, J. (1988). Statistical power analysis for the behavioral sciences (2nd ed.). Lawrence Erlbaum Associates.

Cumming, G. (2012). Understanding the new statistics: Effect sizes, confidence intervals, and meta-analysis. Routledge.

Hedges, L. V. (1981). Distribution theory for Glass's estimator of effect size and related estimators. Journal of Educational Statistics, 6(2), 107-128. https://doi.org/10.3102/10769986006002107

Nakagawa, S., & Cuthill, I. C. (2007). Effect size, confidence interval and statistical significance: A practical guide for biologists. Biological Reviews, 82(4), 591-605. https://doi.org/10.1111/j.1469-185X.2007.00027.x

## Estimating Cohen's d or Hedges' g from a Ratio of Odds Ratios

The `esc_ratio_odds_ratio` function estimates Cohen's d or Hedges' g effect sizes from a reported ratio of odds ratios, its standard error or confidence interval, sample sizes, and the population baseline rate. The method relies on several assumptions and approximations to convert the ratio of odds ratios to a standardized mean difference.

### Assumptions

1. The ratio of odds ratios is a measure of the relative difference in odds between the treatment and comparison groups, with the comparison group as the reference [@szumilas2010].
2. The standard error of the ratio of odds ratios is either provided or can be calculated from the confidence interval assuming a normal distribution of the log ratio of odds ratios [@altman2011].
3. The population baseline rate represents the proportion of the population experiencing the event at baseline and is known or can be estimated [@rothman2008].
4. The event counts in the treatment and comparison groups follow a binomial distribution [@fleiss2003].
5. The sample sizes of the treatment and comparison groups are known.

### Step 1: Obtain the standard error of the log ratio of odds ratios

The function first obtains the standard error of the log ratio of odds ratios either directly from the provided `ratio_odds_ratio_se` argument or by calculating it from the confidence interval using the following formula [@altman2011]:

$$
SE_{log(ROR)} = \frac{log(ROR_{upper}) - log(ROR_{lower})}{2 \times 1.96}
$$

```{r}
se_log_ratio_odds_ratio <- (log_ratio_odds_ratio_ci_upper - log_ratio_odds_ratio_ci_lower) / (2 * 1.96)
```

where $SE_{log(ROR)}$ is the standard error of the log ratio of odds ratios, $ROR_{upper}$ and $ROR_{lower}$ are the upper and lower bounds of the ratio of odds ratios confidence interval, respectively.

### Step 2: Convert the ratio of odds ratios to the log scale

The ratio of odds ratios is converted to the log scale:

$$
log(ROR) = log(ROR)
$$

```{r}
log_ratio_odds_ratio <- log(ratio_odds_ratio)
```

where $log(ROR)$ is the log ratio of odds ratios.

### Step 3: Estimate the event probabilities and odds

The event probability in the comparison group is estimated using the population baseline rate:

$$
P_C = BR
$$

where $P_C$ is the event probability in the comparison group, and $BR$ is the population baseline rate.

```{r}
comparison_event_prob <- population_baseline_rate
```

The odds in the comparison group are estimated using the event probability:

$$
O_C = \frac{P_C}{1 - P_C}
$$

where $O_C$ is the odds in the comparison group.

```{r}
comparison_odds <- comparison_event_prob / (1 - comparison_event_prob)
```

The odds in the treatment group are estimated using the ratio of odds ratios and the comparison odds:

$$
O_T = O_C \times ROR
$$

where $O_T$ is the odds in the treatment group, and $ROR$ is the ratio of odds ratios.

```{r}
treatment_odds <- comparison_odds * ratio_odds_ratio
```

The event probability in the treatment group is estimated using the treatment odds:

$$
P_T = \frac{O_T}{1 + O_T}
$$

where $P_T$ is the event probability in the treatment group.

```{r}
treatment_event_prob <- treatment_odds / (1 + treatment_odds)
```

### Step 4: Convert event probabilities to approximate event counts

The event probabilities are converted to approximate event counts using the sample sizes:

$$
E_T = n_T \times P_T \\
E_C = n_C \times P_C
$$

where $E_T$ and $E_C$ are the event counts in the treatment and comparison groups, respectively, and $n_T$ and $n_C$ are the sample sizes of the treatment and comparison groups, respectively.

```{r}
treatment_event_count <- treatment_n * treatment_event_prob
comparison_event_count <- comparison_n * comparison_event_prob
```

### Step 5: Calculate the pooled event rate and standard deviation

The pooled event count is calculated as the average of the treatment and comparison event counts:

$$
E_P = \frac{E_T + E_C}{2}
$$

where $E_P$ is the pooled event count.

```{r}
pooled_event_count <- (treatment_event_count + comparison_event_count) / 2
```

The pooled event rate is then estimated by dividing the pooled event count by the average of the treatment and comparison sample sizes:

$$
R_P = \frac{E_P}{\frac{n_T + n_C}{2}}
$$

where $R_P$ is the pooled event rate.

```{r}
pooled_event_rate <- pooled_event_count / ((treatment_n + comparison_n) / 2)
```

The pooled standard deviation is estimated using the pooled event rate, assuming a binomial distribution [@fleiss2003]:

$$
SD_P = \sqrt{R_P \times (1 - R_P)}
$$

where $SD_P$ is the pooled standard deviation.

```{r}
pooled_sd <- sqrt(pooled_event_rate * (1 - pooled_event_rate))
```

### Step 6: Calculate Cohen's d

Cohen's d is calculated using the estimated event probabilities for the treatment and comparison groups and the pooled standard deviation [@cohen1988]:

$$
d = \frac{P_T - P_C}{SD_P}
$$

where $d$ is Cohen's d.

```{r}
cohens_d <- (treatment_event_prob - comparison_event_prob) / pooled_sd
```

### Step 7: Calculate the standard error and confidence interval for Cohen's d

The standard error for Cohen's d is estimated using the event probabilities and sample sizes [@hasselblad1995]:

$$
SE_d = \sqrt{\frac{P_T \times (1 - P_T)}{n_T} + \frac{P_C \times (1 - P_C)}{n_C}} \times \frac{1}{SD_P}
$$

where $SE_d$ is the standard error for Cohen's d, $P_T$ and $P_C$ are the event probabilities in the treatment and comparison groups, respectively, $n_T$ and $n_C$ are the sample sizes of the treatment and comparison groups, respectively, and $SD_P$ is the pooled standard deviation.

standard_error_d <- sqrt((treatment_event_prob * (1 - treatment_event_prob)) / treatment_n + (comparison_event_prob * (1 - comparison_event_prob)) / comparison_n) / pooled_sd

The confidence interval for Cohen's d is then calculated using the standard error [@nakagawa2007]:

$$
CI_d = [d - 1.96 \times SE_d, d + 1.96 \times SE_d]
$$

where $CI_d$ is the confidence interval for Cohen's d.

```{r}
cohens_d_ci_lower <- cohens_d - (1.96 * standard_error_d)
cohens_d_ci_upper <- cohens_d + (1.96 * standard_error_d)
```

### Step 8: Calculate the p-value

The Z-statistic is calculated using the log ratio of odds ratios and its standard error:

$$
Z = \frac{log(ROR)}{SE_{log(ROR)}}
$$

where $Z$ is the Z-statistic.

```{r}
z_stat <- log_ratio_odds_ratio / se_log_ratio_odds_ratio
```

The p-value is then calculated using the standard normal distribution:

```{r}
p_value <- 2 * (1 - pnorm(abs(z_stat)))
```

### Step 9: Calculate Hedges' g (optional)

If the `esc_type` argument is set to 'g', the function also calculates Hedges' g, which is an unbiased estimate of the standardized mean difference [@hedges1981]:

$$
g = d \times \left(1 - \frac{3}{4 \times (n_T + n_C) - 9}\right)
$$

where $g$ is Hedges' g.

```{r}
hedges_g <- cohens_d * (1 - (3 / (4 * (treatment_n + comparison_n) - 9)))
```

The confidence interval for Hedges' g is calculated using the same standard error as Cohen's d.

## References

Altman, D. G., & Bland, J. M. (2011). How to obtain the confidence interval from a P value. BMJ, 343, d2090. https://doi.org/10.1136/bmj.d2090

Cohen, J. (1988). Statistical power analysis for the behavioral sciences (2nd ed.). Lawrence Erlbaum Associates.

Fleiss, J. L., Levin, B., & Paik, M. C. (2003). Statistical methods for rates and proportions (3rd ed.). John Wiley & Sons.

Hasselblad, V., & Hedges, L. V. (1995). Meta-analysis of screening and diagnostic tests. Psychological Bulletin, 117(1), 167-178. https://doi.org/10.1037/0033-2909.117.1.167

Hedges, L. V. (1981). Distribution theory for Glass's estimator of effect size and related estimators. Journal of Educational Statistics, 6(2), 107-128. https://doi.org/10.3102/10769986006002107

Nakagawa, S., & Cuthill, I. C. (2007). Effect size, confidence interval and statistical significance: A practical guide for biologists. Biological Reviews, 82(4), 591-605. https://doi.org/10.1111/j.1469-185X.2007.00027.x

Rothman, K. J., Greenland, S., & Lash, T. L. (2008). Modern epidemiology (3rd ed.). Lippincott Williams & Wilkins.

Szumilas, M. (2010). Explaining odds ratios. Journal of the Canadian Academy of Child and Adolescent Psychiatry, 19(3), 227-229.
